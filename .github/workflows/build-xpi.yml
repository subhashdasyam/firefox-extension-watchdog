name: Build Firefox XPI

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  workflow_dispatch: {}

jobs:
  build-xpi:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build XPI with web-ext
        run: |
          npx --yes web-ext --version
          npx --yes web-ext build \
            -s . \
            -a web-ext-artifacts \
            --overwrite-dest \
            --ignore-files \
              ".git/**" \
              ".github/**" \
              ".venv/**" \
              "web-ext-artifacts/**" \
              "*.zip"

      - name: Normalize artifact extension
        run: |
          for f in web-ext-artifacts/*.zip; do
            [ -e "$f" ] || continue
            mv "$f" "${f%.zip}.xpi"
          done

      - name: Upload XPI artifact
        uses: actions/upload-artifact@v4
        with:
          name: firefox-extension-xpi
          path: web-ext-artifacts/*.xpi
          if-no-files-found: error

      - name: Create GitHub release (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: web-ext-artifacts/*.xpi
